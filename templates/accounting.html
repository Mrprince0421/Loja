<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contabilidade Diária</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="navbar">
                <a href="/">Home</a>
                <div id="logged-out-nav" style="display: none;">
                    <a href="/login">Login</a>
                    <a href="/register">Cadastro</a>
                </div>
                <div id="logged-in-nav" style="display: none;">
                    <a href="/products-page">Produtos</a>
                    <a href="/sales">Vendas</a>
                    <a href="/accounting">Contabilidade</a>
                    <a href="#" onclick="logout()">Sair</a>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <h1>Relatórios de Contabilidade</h1>
        <div class="content">
            <div class="form-section">
                <h2>Relatório do Dia</h2>
                <div class="response-section">
                    <div id="daily-sales-report-display">
                        <h3>Carregando dados...</h3>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>Vendas por Período</h2>
                <form id="sales-by-period-form">
                    <label for="start-date">Data de Início:</label>
                    <input type="date" id="start-date" name="start_date" required>
                    <label for="end-date">Data de Fim:</label>
                    <input type="date" id="end-date" name="end_date" required>
                    <button type="submit" id="sales-by-period-submit">
                        Gerar Relatório
                        <span class="loading-spinner" id="sales-by-period-spinner"></span>
                    </button>
                </form>
                <div class="response-section">
                    <div id="sales-by-period-display"></div>
                </div>
            </div>

            <div class="form-section">
                <h2>Produtos Mais Vendidos</h2>
                <form id="best-selling-form">
                    <label for="limit">Número de Produtos:</label>
                    <input type="number" id="limit" name="limit" value="10" min="1" max="100" required>
                    <button type="submit" id="best-selling-submit">
                        Gerar Relatório
                        <span class="loading-spinner" id="best-selling-spinner"></span>
                    </button>
                </form>
                <div class="response-section">
                    <div id="best-selling-display"></div>
                </div>
            </div>

            <div class="response-section" style="flex-basis: 100%;">
                <div id="alert-message"></div>
            </div>
        </div>
    </div>

    <script src="/static/api.js"></script>
    <script>
        const loggedInNav = document.getElementById('logged-in-nav');
        const loggedOutNav = document.getElementById('logged-out-nav');

        function checkAuth() {
            const accessToken = localStorage.getItem('accessToken');
            if (accessToken) {
                loggedInNav.style.display = 'flex';
                loggedOutNav.style.display = 'none';
            } else {
                loggedInNav.style.display = 'none';
                loggedOutNav.style.display = 'flex';
                const protectedPages = ['/products-page', '/sales', '/accounting', '/create-product-page', '/update-product-page', '/delete-product-page'];
                if (protectedPages.includes(window.location.pathname) && !accessToken) {
                    window.location.href = '/login';
                }
            }
        }

        function logout() {
            localStorage.removeItem('accessToken');
            window.location.href = '/';
        }
        checkAuth();

        const baseURL = window.location.origin;
        const alertMessage = document.getElementById('alert-message');
        const dailySalesDisplayEl = document.getElementById('daily-sales-report-display');
        const salesByPeriodDisplayEl = document.getElementById('sales-by-period-display');
        const bestSellingDisplayEl = document.getElementById('best-selling-display');

        function showLoading(buttonId, spinnerId) {
            document.getElementById(buttonId).disabled = true;
            document.getElementById(spinnerId).style.display = 'inline-block';
        }

        function hideLoading(buttonId, spinnerId) {
            document.getElementById(buttonId).disabled = false;
            document.getElementById(spinnerId).style.display = 'none';
        }

        async function fetchDailyReport() {
            try {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) return;

                const response = await fetch(`${baseURL}/sales/daily_report`, {
                    method: 'GET',
                    headers: {'Authorization': `Bearer ${accessToken}`},
                });

                const result = await handleResponse(response);
                dailySalesDisplayEl.innerHTML = `
                    <h3>Resumo do Dia</h3>
                    <p>Total de Vendas: <strong>${result.total_sales}</strong></p>
                    <p>Valor Total Arrecadado: <strong>R$ ${result.total_amount.toFixed(2)}</strong></p>
                `;

            } catch (error) {
                handleError(error, alertMessage);
                dailySalesDisplayEl.innerHTML = `<p style="color:red;">Erro ao carregar o relatório diário.</p>`;
            }
        }
        fetchDailyReport();

        document.getElementById('sales-by-period-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            alertMessage.innerHTML = '';
            salesByPeriodDisplayEl.innerHTML = '<h3>Carregando...</h3>';

            const formData = new FormData(e.target);
            const startDate = formData.get('start_date');
            const endDate = formData.get('end_date');

            showLoading('sales-by-period-submit', 'sales-by-period-spinner');

            try {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) throw new Error('Token de acesso não encontrado. Faça login primeiro.');

                const response = await fetch(`${baseURL}/sales/report_by_period?start_date=${startDate}&end_date=${endDate}`, {
                    method: 'GET',
                    headers: {'Authorization': `Bearer ${accessToken}`},
                });

                const result = await handleResponse(response);
                if (result.sales.length === 0) {
                    salesByPeriodDisplayEl.innerHTML = '<p>Nenhuma venda encontrada no período.</p>';
                    return;
                }

                let html = '<h3>Vendas por Período</h3><ul>';
                result.sales.forEach(sale => {
                    html += `<li><strong>${new Date(sale.sale_date).toLocaleString()}</strong> - Produto: ${sale.product_name}, Quantidade: ${sale.quantity_sold}, Valor Total: R$ ${sale.total_price.toFixed(2)}</li>`;
                });
                html += '</ul>';
                salesByPeriodDisplayEl.innerHTML = html;

            } catch (error) {
                handleError(error, alertMessage);
                salesByPeriodDisplayEl.innerHTML = '';
            } finally {
                hideLoading('sales-by-period-submit', 'sales-by-period-spinner');
            }
        });

        document.getElementById('best-selling-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            alertMessage.innerHTML = '';
            bestSellingDisplayEl.innerHTML = '<h3>Carregando...</h3>';

            const formData = new FormData(e.target);
            const limit = formData.get('limit');

            showLoading('best-selling-submit', 'best-selling-spinner');

            try {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) throw new Error('Token de acesso não encontrado. Faça login primeiro.');

                const response = await fetch(`${baseURL}/sales/best_selling?limit=${limit}`, {
                    method: 'GET',
                    headers: {'Authorization': `Bearer ${accessToken}`},
                });

                const result = await handleResponse(response);
                if (result.products.length === 0) {
                    bestSellingDisplayEl.innerHTML = '<p>Nenhum produto encontrado.</p>';
                    return;
                }

                let html = '<h3>Produtos Mais Vendidos</h3><ol>';
                result.products.forEach(product => {
                    html += `<li><strong>${product.product_name}</strong> - Vendidos: ${product.total_quantity_sold}, Receita Total: R$ ${product.total_revenue.toFixed(2)}</li>`;
                });
                html += '</ol>';
                bestSellingDisplayEl.innerHTML = html;

            } catch (error) {
                handleError(error, alertMessage);
                bestSellingDisplayEl.innerHTML = '';
            } finally {
                hideLoading('best-selling-submit', 'best-selling-spinner');
            }
        });
    </script>
</body>
</html>